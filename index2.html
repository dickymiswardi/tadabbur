<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Al-Qur'an Digital - Clean Version</title>
  <!-- (Saya ringkas header dan style, supaya fokus di bagian script) -->
</head>
<body>
  <!-- Semua bagian interface tetap seperti file asli -->

  <div id="result">
    <div class="loader">
      <img src="https://raw.githubusercontent.com/dickymiswardi/tadabbur/aa160525691e67e5d0b7aab1e7e9f37657d0ed45/AnimatedBook.gif" class="loading-icon" />
    </div>
  </div>

  <script>
    const quranJSONUrl = "https://raw.githubusercontent.com/dickymiswardi/tadabbur/refs/heads/main/quran.json";
    const surah = parseInt(new URLSearchParams(window.location.search).get("surah") || "1");
    const ayat = parseInt(new URLSearchParams(window.location.search).get("ayat") || "1");

    function toArabicNumber(n) {
      const map = ["٠", "١", "٢", "٣", "٤", "٥", "٦", "٧", "٨", "٩"];
      return String(n).split('').map(d => map[parseInt(d)]).join('');
    }

    function wrapRasmSymbols(text) {
      text = text.replace(/ً\s*ۢ\s*ا/g, 'ًا<sup class="rasm-symbol rasm-symbol-special">ۢ</sup>');
      text = text.replace(/ن\s*ۢ/g, 'ن');
      return text.replace(/([ۭۛۖۚۗۙۘۜۢ])/g, match => {
        if (match === 'ۢ' || match === 'ۭ') {
          return ' <sup class="rasm-symbol rasm-symbol-special">' + match + '</sup> ';
        } else {
          return ' <sup class="rasm-symbol">' + match + '</sup> ';
        }
      });
    }

    Promise.all([
      fetch(quranJSONUrl).then(res => res.json()),
      fetch("indonesian_complex_v1.0.xml").then(res => res.text())
    ]).then(([quranData, xmlText]) => {
      const chapterObj = quranData.find(obj => obj[surah]);
      let arabicText = "(Teks Arab tidak ditemukan)";
      if (chapterObj) {
        const chapterData = chapterObj[surah];
        const verseObj = chapterData.text.find(v => v.verseNumber == ayat);
        if (verseObj) arabicText = verseObj.text;
      }
      arabicText += ` \u06dd${toArabicNumber(ayat)}`;
      arabicText = wrapRasmSymbols(arabicText);

      const arabDiv = document.createElement('div');
      arabDiv.className = 'arabic';
      arabDiv.innerHTML = arabicText;
      document.getElementById("result").innerHTML = '';
      document.getElementById("result").appendChild(arabDiv);

      // Parsing translation (kode xml parser tetap)
      const parser = new DOMParser();
      const xmlDoc = parser.parseFromString(xmlText, "text/xml");
      const translationAyah = xmlDoc.querySelector(`sura[number="${surah}"] > aya[number="${ayat}"]`);
      let translation = translationAyah?.querySelector("translation")?.textContent || "(Terjemahan tidak ditemukan)";
      translation = translation.replace(/(\d+)/g, '<sup>($1)</sup>');
      const translationDiv = document.createElement("div");
      translationDiv.className = "translation";
      translationDiv.innerHTML = translation;
      document.getElementById("result").appendChild(translationDiv);

      // (Bagian tafsir, footnote, audio, navigasi dibiarkan sama persis dengan versi kamu)

    }).catch(err => {
      console.error(err);
      document.getElementById("result").textContent = "Gagal memuat data.";
    });
  </script>
</body>
</html>
